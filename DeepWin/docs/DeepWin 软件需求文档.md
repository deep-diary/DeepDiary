# DeepWin 软件需求文档

## 1. 引言

### 1.1 编写目的

本文档旨在详细描述 DeepWin 桌面应用程序的各项功能和非功能需求，为项目的开发、测试、部署和未来的迭代提供清晰的指导。本需求文档不仅供开发团队参考，也期望能够为 AI 辅助开发工具（如 Cursor）提供足够详细的上下文，以促进智能化的开发流程。

### 1.2 目标读者

- 产品经理
- 项目经理
- 系统架构师
- 软件开发工程师
- 测试工程师
- UI/UX 设计师
- AI 辅助开发工具

### 1.3 术语和缩写

- **DeepWin**：DeepDiary 项目的桌面 GUI 应用程序，作为云端与本地设备的桥梁。
- **DeepServer**：DeepDiary 项目的云端服务器，负责数据存储、API 服务、AI 处理等。
- **DeepDevice**：DeepDiary 项目的硬件设备端，包括 DeepGlass、DeepArm、DeepToy。
- **GUI**：图形用户界面（Graphical User Interface）。
- **API**：应用程序编程接口（Application-Programming Interface）。
- **MQTT**：消息队列遥测传输协议（Message Queuing Teleport Transport）。
- **ORM**：对象关系映射（Object Relational Mapping）。
- **Agent（智能体）**：具备感知、推理、行动和通信能力的自主软件实体。
- **PySide6-Fluent-Widgets**：用于构建 Fluent Design 风格 UI 的 PySide6 扩展库。

## 2. 总体需求

### 2.1 系统目标

DeepWin 作为 DeepDiary 生态的核心桌面应用，其主要目标是：

- **本地记忆管理**：提供强大、便捷的多模态记忆（照片、视频、日记、聊天记录等）本地管理与追溯能力。
- **设备桥接与控制**：作为 DeepDevice（特别是串口通信设备如 DeepArm、DeepToy）与云端 DeepServer 之间的桥梁，实现本地设备的直观控制、数据采集和智能交互。
- **云端数据同步**：确保本地数据与云端 DeepServer 之间高效、可靠的双向同步，保证数据一致性。
- **智能体宿主**：为 DeepWin 内部的智能体提供运行环境和协调机制，逐步实现主动式、个性化的智能服务。
- **用户体验**：提供现代化、流畅、易用的用户界面和交互体验。

### 2.2 功能概述

DeepWin 的主要功能模块包括：

- **用户界面模块 (UI)**：提供所有用户可见的交互界面。
- **应用逻辑模块 (Application Logic)**：
  - 核心管理器：负责应用内部的协调与任务调度。
  - 记忆处理：处理图像、视频、日记、聊天记录和 GPS 轨迹等各类记忆数据。
  - 资源/需求管理：本地化管理用户的资源和需求信息。
  - 设备逻辑管理：处理与 DeepDevice 设备的复杂业务逻辑。
  - AI 功能协调：协调本地 AI 处理和云端 AI 服务。
  - 智能体层：管理和运行 DeepWin 内部的智能体。
- **服务模块 (Service Layer)**：封装与云端 DeepServer 和本地硬件设备的通信。
- **数据管理模块 (Data Management)**：负责 DeepWin 本地数据存储和日志管理。

## 3. 功能需求详细描述

### 3.1 用户界面模块 (UI Layer)

- **REQ-UI-001：主窗口框架**
  - 提供包含导航栏、内容区和状态栏的现代化主窗口布局。
  - 支持窗口最大化、最小化、关闭等标准操作。
  - 支持主题切换（明亮/黑暗模式），并可根据系统主题自动调整。
  - 支持用户自定义导航栏的显示/隐藏或布局。
- **REQ-UI-002：记忆管理界面**
  - **REQ-UI-002.1：照片与视频视图**
    - 以网格或列表形式展示本地照片和视频文件，支持缩略图预览。
    - 提供按时间、地点、人物、标签、类型等条件进行筛选和排序的功能。
    - 支持全屏查看照片，播放视频，并显示相关元数据（EXIF、GPS）。
    - 支持对照片和视频进行基础编辑操作（旋转、裁剪、简单滤镜）。
    - 提供人脸标注工具，支持用户手动命名未识别的人脸。
  - **REQ-UI-002.2：日记与笔记视图**
    - 提供富文本编辑器，支持文本、图片、超链接等内容插入。
    - 支持Markdown格式的导入和导出。
    - 提供按日期、关键词、标签进行检索和过滤的功能。
    - 支持日记的创建、编辑、删除。
  - **REQ-UI-002.3：聊天记录视图**
    - 展示导入的微信聊天记录，保持原汁原味的对话流。
    - 支持按联系人、关键词、时间范围进行搜索和筛选。
    - 提供聊天记录内容的摘要和关键信息提取功能（通过应用逻辑层实现）。
  - **REQ-UI-002.4：GPS 轨迹视图**
    - 在地图组件上可视化展示用户的 GPS 轨迹。
    - 支持按日期范围选择轨迹。
    - 支持查看轨迹点上的记忆事件（如照片、日记）。
- **REQ-UI-003：设备控制界面**
  - 以列表或树形结构展示 DeepWin 发现并连接的 DeepDevice 设备。
  - 实时显示每个设备的连接状态、运行状态、关键传感器数据。
  - 针对 DeepArm 机械臂：提供直观的控制面板（关节角度、坐标控制），支持手动操作、示教模式切换、轨迹播放。
  - 针对 DeepToy：提供外设控制界面（如 PWM 舵机控制、IO 状态显示）。
  - 提供指令输入框和发送按钮，允许用户手动发送控制指令。
- **REQ-UI-004：资源/需求管理界面**
  - 分别展示用户自身的资源列表和需求列表。
  - 支持资源和需求的创建、编辑、删除。
  - 支持为资源和需求添加标签、描述、价格/预算等属性。
  - 显示来自云端 DeepServer 的资源/需求匹配建议。
- **REQ-UI-005：设置界面**
  - **REQ-UI-005.1：账户管理**：登录/登出、个人资料查看与修改。
  - **REQ-UI-005.2：数据同步设置**：配置自动同步频率、冲突解决策略。
  - **REQ-UI-005.3：目录管理**：配置本地记忆数据（照片、视频、日记等）的扫描目录。
  - **REQ-UI-005.4：通用设置**：主题切换、语言选择、通知设置等。
- **REQ-UI-006：日志显示界面**
  - 实时滚动显示应用程序的运行日志，支持不同日志级别（INFO, WARNING, ERROR等）的过滤。
  - 提供日志搜索功能。
  - 支持将日志导出到文件。
- **REQ-UI-007：语音交互指示**
  - 在主界面提供语音输入状态指示（如麦克风图标变化、波形动画）。
  - 显示语音识别结果和当前执行的语音命令反馈。

### 3.2 应用逻辑层 (Application Logic Layer)

- **REQ-AL-001：核心管理器**
  - **REQ-AL-001.1：应用生命周期管理**：负责 DeepWin 的启动、初始化、资源加载、关闭等。
  - **REQ-AL-001.2：模块协调与事件分发**：作为中央协调器，处理来自 UI、服务层、数据管理层的事件，并分发给相应的业务模块或智能体。
  - **REQ-AL-001.3：任务调度器**：
    - 管理后台异步任务，如大文件处理、数据同步、AI 模型推理。
    - 提供任务队列、优先级管理和执行状态监控。
- **REQ-AL-002：记忆处理模块**
  - **REQ-AL-002.1：图像与视频处理**
    - **REQ-AL-002.1.1：本地文件扫描与监控**：持续扫描用户指定目录，自动发现新增/修改的图像和视频文件。
    - **REQ-AL-002.1.2：元数据提取**：从照片 EXIF、视频文件中自动提取时间、地点（GPS）、设备型号、分辨率等元数据。
    - **REQ-AL-002.1.3：AI 信息提取**：
      - 调用本地或云端 AI 服务（通过 `AI Coordinator` 和 `Cloud Communication Service`），提取图像/视频中的人脸信息、物体识别结果、场景语义信息。
      - **REQ-AL-002.1.4：Immich API 集成**：通过 DeepServer 的 Immich API，获取其已处理的照片/视频（包括向量化特征、智能标签、分类等），并同步到本地。
    - **REQ-AL-002.1.5：本地索引构建**：为所有记忆数据建立高效的本地索引，支持关键词、元数据和语义搜索。
  - **REQ-AL-002.2：日记与笔记处理**
    - 支持日记内容的本地创建、编辑、保存。
    - 对日记文本进行分词、关键词提取，并构建本地全文搜索索引。
    - 支持与云端 DeepServer 的日记同步。
  - **REQ-AL-002.3：聊天记录处理**
    - 支持从本地微信数据库（或其他聊天应用）导入并解析聊天记录。
    - 对聊天内容进行初步分析，提取关键人物、时间、地点和主题。
    - 支持聊天记录的本地存储和搜索。
  - **REQ-AL-002.4：GPS 轨迹处理**
    - 支持导入来自 DeepGlass 或其他设备的 GPS 轨迹数据。
    - 对轨迹数据进行清洗、优化（如去噪、路径平滑）。
    - 将轨迹数据关联到时间点附近的记忆（照片、日记）。
- **REQ-AL-003：资源/需求管理器**
  - 管理用户在 DeepWin 中录入和修改的资源（技能、物品、时间）和需求信息。
  - 确保本地资源/需求数据与云端 DeepServer 的双向同步。
  - 提供本地化的资源/需求搜索和过滤功能。
- **REQ-AL-004：设备逻辑管理器**
  - 管理 DeepWin 与 DeepDevice 设备（DeepArm, DeepToy等）之间的复杂业务逻辑。
  - 将来自 UI 或智能体的抽象控制指令（如“机械臂移动到 A 点”）转化为设备协议解析器可识别的底层命令。
  - 接收设备协议解析器处理后的原始数据，并将其转化为结构化数据，更新设备状态模型。
  - 处理设备状态的实时更新、异常检测和告警逻辑。
  - 管理 DeepArm 的示教轨迹录制、存储和播放逻辑。
- **REQ-AL-005：AI 功能协调器**
  - 协调 DeepWin 内部 AI 库（如 OpenCV）的调用，用于基础图像处理、人脸检测等。
  - 管理与 DeepServer AI 服务（如大模型、高级识别服务）的交互，进行复杂自然语言理解、知识问答、图像/视频高级分析等。
  - 负责本地 AI 模型的加载、管理和更新。
- **REQ-AL-006：智能体层 (Agent Layer)**
  - **REQ-AL-006.1：Agent Manager (智能体管理器)**：
    - 负责 DeepWin 内部智能体实例的生命周期管理（实例化、启动、停止、销毁）。
    - 提供智能体注册和发现机制，允许新智能体动态加入系统。
    - 协调智能体间的任务分配、优先级和资源调度。
  - **REQ-AL-006.2：Agent Communication Bus (智能体通信总线)**：
    - 提供基于事件或消息队列的内部通信机制，支持智能体之间异步、解耦的消息传递。
    - 作为与外部智能体（如 DeepServer 上的 Agent）通信的代理，将内部消息转换为外部协议，反之亦然。
  - **REQ-AL-006.3：Perception Adapters (感知适配器)**：
    - 将 DeepWin 内部数据（来自数据管理层、服务层、业务逻辑模块）转换为智能体可感知的“世界状态”或“事件”。
    - 例如：新的记忆导入事件、设备状态变化、用户操作日志、云端通知、用户习惯分析报告等。
  - **REQ-AL-006.4：Action Dispatchers (行动分发器)**：
    - 将智能体做出的决策或行动指令，转化为 DeepWin 内部可执行的操作。
    - 例如：调用设备逻辑管理器控制设备、调用数据管理层更新数据、触发云端通信服务发送请求、向 UI 层发送通知。
  - **REQ-AL-006.5：核心智能体 (Core Agents)**：
    - **MemoryCuratorAgent（记忆策展智能体）**：主动分析新旧记忆，发现关联，建议标签，提醒用户回顾，清理重复或低价值记忆。
    - **ResourceMatcherAgent（资源匹配智能体）**：分析用户行为和需求，主动在资源网络中寻找匹配项，并推荐联系人。
    - **DeviceSupervisorAgent（设备监控智能体）**：监控设备状态，预警潜在故障，建议维护，并根据情境智能调整设备行为。
    - **UserAssistantAgent（用户助理智能体）**：根据用户上下文提供主动帮助、信息查询、个性化推荐，并作为用户的数字分身进行简单交互。

### 3.3 服务层 (Service Layer)

- **REQ-SVC-001：云端通信服务**
  - **REQ-SVC-001.1：API 客户端**：
    - 封装 DeepServer 提供的 RESTful API 调用，包括用户认证、数据CRUD操作（记忆、资源、需求、设备信息等）。
    - 集成第三方 API（如 Immich API、Mem0 API 等），获取其处理后的数据。
    - 实现统一的错误处理和重试机制。
  - **REQ-SVC-001.2：MQTT 客户端**：
    - 建立并维护与 DeepServer (EMQX) 的 MQTT 连接。
    - 支持订阅/发布机制，用于设备状态更新、远程控制指令、系统通知等。
    - 作为 DeepWin 内部智能体与 DeepServer 外部智能体之间通信的底层传输。
  - **REQ-SVC-001.3：流媒体客户端**：
    - 接收来自 DeepDevice（通过 MediaMTX 转发）的实时视频流，并支持解码。
    - 接收来自 LiveKit 的实时语音流，并支持发送本地语音数据。
  - **REQ-SVC-001.4：数据同步管理器**：
    - 负责协调本地 SQLite 数据库与云端 PostgreSQL 数据库之间的数据同步。
    - 实现增量同步、冲突解决策略（时间戳优先、用户选择、合并）。
    - 支持定时同步和用户手动触发同步。
- **REQ-SVC-002：本地硬件通信服务**
  - **REQ-SVC-002.1：串口通信模块**：建立、维护和管理与 DeepArm、DeepToy 等设备的串口连接，实现原始数据收发。
  - **REQ-SVC-002.2：CAN 总线通信模块**：支持与使用 CAN 总线通信的 DeepDevice 设备进行数据交换（如果适用），并提供 DBC 文件解析能力。
  - **REQ-SVC-002.3：设备协议解析器**：根据不同 DeepDevice 设备的私有协议，将原始字节流解析为结构化数据，并将应用逻辑层的命令转换为设备可识别的协议格式。
  - **REQ-SVC-002.4：驱动管理**：管理本地硬件设备的驱动加载和卸载。

### 3.4 数据管理层 (Data Management Layer)

- **REQ-DM-001：本地数据库 (SQLite3)**
  - 存储 DeepWin 本地缓存的记忆数据元数据和部分内容，以及本地文件路径。
  - 存储用户配置、应用设置和设备配置、示教轨迹等。
  - 作为云端数据同步的本地副本，支持离线操作。
  - 提供 ORM 或 DAO 接口，供应用逻辑层进行数据存取。
- **REQ-DM-002：日志管理**
  - 记录 DeepWin 应用程序的运行日志（DEBUG, INFO, WARNING, ERROR, CRITICAL）。
  - 支持日志文件按大小或日期滚动。
  - 支持日志的本地写入、查看、搜索和导出。
  - 关键日志（ERROR, CRITICAL）可配置同步到云端 DeepServer。

## 4. 非功能需求

### 4.1 性能需求

- **响应时间**：DeepWin 界面操作响应时间应在 200ms 以内；本地数据查询应在 500ms 以内。
- **启动速度**：应用程序启动时间应在 3 秒以内。
- **资源占用**：在空闲状态下，CPU 占用率应低于 5%，内存占用应低于 200MB（可根据实际情况调整）；在重载（如导入大量照片）时，CPU 占用峰值不应导致系统卡顿，内存占用应在可接受范围内。
- **图像/视频处理效率**：导入和处理 1000 张照片（平均 5MB/张）应在 5 分钟内完成，并支持后台异步处理，不阻塞 UI。
- **数据同步效率**：在良好网络环境下，同步 1GB 数据（假设大部分为图片）应在 10 分钟内完成。
- **智能体运行效率**：智能体在后台运行时，不应对 DeepWin 主体性能造成明显影响，其决策生成和行动响应时间应在 1 秒以内。

### 4.2 安全性需求

- **本地数据加密**：对存储在本地 SQLite 中的用户凭证、敏感记忆内容等关键数据进行加密存储。
- **通信加密**：所有与 DeepServer 的网络通信必须使用 HTTPS/TLS/SSL 进行加密。
- **设备认证**：确保 DeepWin 仅与通过认证的 DeepDevice 设备进行通信。
- **权限管理**：应用程序内部应有基本的权限管理，避免未经授权的模块或智能体访问敏感功能或数据。
- **安全审计**：重要操作（如数据同步、设备控制）应记录到日志中，便于追溯。

### 4.3 可靠性需求

- **系统稳定性**：DeepWin 应稳定运行，长时间使用不崩溃。
- **数据一致性**：确保本地数据与云端数据在同步过程中始终保持一致，并能妥善处理同步冲突。
- **故障恢复**：在应用程序异常退出后，应能恢复到最近一次的有效状态，避免数据丢失。
- **设备连接稳定性**：与 DeepDevice 设备的连接应稳定，支持自动重连机制。
- **智能体鲁棒性**：智能体应能处理感知数据异常、行动执行失败等情况，并从错误中恢复或降级。

### 4.4 可维护性需求

- **模块化设计**：遵循高内聚低耦合原则，各模块职责清晰，接口定义明确，便于独立开发、测试和维护。
- **代码规范**：遵循 Python PEP 8 编码规范，编写清晰、可读、带注释的代码。
- **日志记录**：提供详细、可配置的日志记录机制，便于问题诊断和追踪。
- **配置管理**：应用程序配置应集中管理，支持通过配置文件（如 `settings.ini`）进行修改，无需重新编译。
- **可测试性**：各模块应易于进行单元测试和集成测试。
- **智能体管理**：提供机制（命令行或界面）来管理、监控和调试智能体的运行状态及行为。

### 4.5 可扩展性需求

- **新记忆类型支持**：架构应允许轻松添加对新的记忆类型（如音频、文档）的处理。
- **新设备类型支持**：硬件通信服务应能通过配置或插件方式支持新的 DeepDevice 类型。
- **第三方服务集成**：API 客户端应具备灵活的扩展能力，方便集成新的第三方 API 服务。
- **智能体扩展**：智能体层应支持动态加载新的智能体，并允许现有智能体功能的升级和扩展，无需修改核心框架。
- **通信协议扩展**：服务层应易于扩展，支持新的通信协议（如 gRPC）。

### 4.6 用户体验需求

- **直观易用**：界面布局清晰，操作流程直观，降低用户学习成本。
- **流畅响应**：界面操作不卡顿，后台任务不阻塞主线程。
- **视觉一致性**：遵循 Fluent Design 风格，各界面元素保持一致的视觉和交互体验。
- **反馈及时**：用户操作后，系统应提供及时、清晰的反馈。
- **个性化设置**：提供主题、语言、同步策略等个性化设置选项。

## 5. 总结

本文档详细阐述了 DeepWin 桌面应用程序的功能和非功能需求，特别强调了其作为 DeepDiary 生态系统中关键组件的角色，以及为未来智能体功能集成所做的架构准备。本需求文档将作为项目开发的基础，指导开发团队构建一个功能强大、稳定可靠、高度可扩展且用户体验优良的桌面应用。
